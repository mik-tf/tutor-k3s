apiVersion: v1
kind: ConfigMap
metadata:
  name: tutor-resource-reducer
  namespace: kube-system
data:
  reduce-resources.sh: |
    #!/bin/bash
    set -e
    
    echo "Reducing resource requirements for OpenedX components..."
    
    TUTOR_BIN="{{ venv_dir }}/bin/tutor"
    
    # Set minimal resource requirements
    $TUTOR_BIN config save --set K8S_RESOURCES_REQUESTS_ENABLED=false
    $TUTOR_BIN config save --set K8S_RESOURCES_LIMITS_ENABLED=true
    $TUTOR_BIN config save --set K8S_RESOURCES_LMS_LIMITS_CPU=1
    $TUTOR_BIN config save --set K8S_RESOURCES_LMS_LIMITS_MEMORY=1Gi
    $TUTOR_BIN config save --set K8S_RESOURCES_CMS_LIMITS_CPU=1
    $TUTOR_BIN config save --set K8S_RESOURCES_CMS_LIMITS_MEMORY=1Gi
    $TUTOR_BIN config save --set K8S_RESOURCES_MYSQL_LIMITS_CPU=0.5
    $TUTOR_BIN config save --set K8S_RESOURCES_MYSQL_LIMITS_MEMORY=512Mi
    $TUTOR_BIN config save --set K8S_RESOURCES_MONGODB_LIMITS_CPU=0.5
    $TUTOR_BIN config save --set K8S_RESOURCES_MONGODB_LIMITS_MEMORY=512Mi
    $TUTOR_BIN config save --set K8S_RESOURCES_ELASTICSEARCH_LIMITS_CPU=0.5
    $TUTOR_BIN config save --set K8S_RESOURCES_ELASTICSEARCH_LIMITS_MEMORY=1Gi
    $TUTOR_BIN config save --set K8S_RESOURCES_REDIS_LIMITS_CPU=0.3
    $TUTOR_BIN config save --set K8S_RESOURCES_REDIS_LIMITS_MEMORY=256Mi
    
    # Set other optimizations
    $TUTOR_BIN config save --set OPENEDX_COMMON_VERSION=19.0.2
    
    echo "Resource requirements reduced successfully"